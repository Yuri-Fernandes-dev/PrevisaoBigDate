<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima Brasil - Mapa Climático</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .map-container {
            margin-bottom: 20px;
            position: relative;
        }
        .weather-popup {
            text-align: center;
            padding: 6px;
            max-width: 220px;
        }
        .weather-popup img {
            width: 60px;
            height: 60px;
        }
        .legend {
            padding: 10px;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            margin: 10px;
            line-height: 24px;
            max-width: 240px;
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
        }
        .legend h6 {
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 50%;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .temp-marker {
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.4);
        }
        #error-message {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center mt-4">
            <div class="col-md-10 col-lg-8">
                <nav class="mb-4">
                    <ul class="nav nav-pills nav-fill bg-white rounded-pill shadow-sm p-2">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('index') }}">
                                <i class="fas fa-home me-2"></i>Página Inicial
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('insights') }}">
                                <i class="fas fa-chart-line me-2"></i>Insights Climáticos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('mapa') }}">
                                <i class="fas fa-map-marked-alt me-2"></i>Visualizar Mapa
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('desastres_naturais') }}">
                                <i class="fas fa-exclamation-triangle me-2"></i>Desastres Naturais
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('sobre') }}">
                                <i class="fas fa-users me-2"></i>Sobre
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <h1 class="text-center text-white mb-4">
                    <i class="fas fa-map-marked-alt me-2"></i>Mapa Climático
                </h1>
                
                <!-- Card do Mapa -->
                <div class="card shadow-lg weather-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="text-center mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>{{ weather.cidade }} 
                            {% if weather.pais %}<span class="badge bg-light text-dark ms-2">{{ weather.pais }}</span>{% endif %}
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-4">
                            <div class="col-md-6 text-center mb-3 mb-md-0">
                                <img src="https://openweathermap.org/img/wn/{{ weather.icone }}@2x.png" alt="{{ weather.descricao }}" class="weather-icon">
                                <h4 class="mt-2 text-capitalize">{{ weather.descricao }}</h4>
                                <h2>{{ weather.temperatura }}°C</h2>
                            </div>
                            <div class="col-md-6">
                                <div class="weather-details">
                                    <p><i class="fas fa-thermometer-half me-2"></i> Sensação térmica: {{ weather.sensacao }}°C</p>
                                    <p><i class="fas fa-wind me-2"></i> Vento: {{ weather.vento }} m/s</p>
                                    <p><i class="fas fa-tint me-2"></i> Umidade: {{ weather.umidade }}%</p>
                                    <p><i class="fas fa-compress-alt me-2"></i> Pressão: {{ weather.pressao }} hPa</p>
                                    <p><i class="fas fa-map-pin me-2"></i> Coordenadas: {{ weather.lat }}, {{ weather.lon }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Controles do Mapa -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="btn-group d-flex" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="btn-mapa-streets"><i class="fas fa-road"></i> Ruas</button>
                                    <button type="button" class="btn btn-outline-info" id="btn-mapa-temp"><i class="fas fa-temperature-high"></i> Temperatura</button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-mapa-satellite"><i class="fas fa-satellite"></i> Satélite</button>
                                    <button type="button" class="btn btn-outline-dark" id="btn-mapa-dark"><i class="fas fa-moon"></i> Noturno</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mapa -->
                        <div class="map-container">
                            <div id="map"></div>
                            <div id="error-message" class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i> 
                                Não foi possível carregar o mapa. Tentando uma alternativa...
                            </div>
                            
                            <!-- Legenda de Temperatura -->
                            <div class="legend" id="temp-legend">
                                <h6>Temperatura</h6>
                                <div class="legend-content">
                                    <!-- Será preenchido via JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botão para abrir no Google Maps -->
                        <div class="text-center mt-3 mb-3">
                            <a href="{{ url_for('abrir_mapa') }}" class="btn btn-primary">
                                <i class="fab fa-google me-2"></i>Abrir no Google Maps
                            </a>
                        </div>
                        
                        <!-- Formulário para buscar novo local no mapa -->
                        <div class="mt-4">
                            <h4 class="mb-3">Buscar outro local no mapa</h4>
                            <form action="/buscar" method="POST" class="d-flex">
                                <input type="text" name="cidade" class="form-control me-2" placeholder="Digite o nome da cidade..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Rodapé -->
                <div class="text-center mt-4 mb-3">
                    <a href="https://openweathermap.org/" target="_blank" class="text-white text-decoration-none small">
                        <span>Dados fornecidos por OpenWeatherMap API</span>
                        <img src="https://openweathermap.org/themes/openweathermap/assets/vendor/owm/img/logo_OpenWeatherMap_orange.svg" alt="OpenWeatherMap" class="ms-2" height="20">
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Coordenadas da localização
            var lat = parseFloat('{{ weather.lat }}');
            var lon = parseFloat('{{ weather.lon }}');
            var cidade = "{{ weather.cidade }}";
            var temperatura = parseInt('{{ weather.temperatura }}');
            var descricao = "{{ weather.descricao }}";
            var icone = "{{ weather.icone }}";
            
            // Esconder legenda inicialmente
            document.getElementById('temp-legend').style.display = 'none';
            
            try {
                // Inicializar o mapa com Leaflet (versão simples)
                var map = L.map('map').setView([lat, lon], 10);
                
                // Camada de mapa base - OpenStreetMap
                var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Camada de satélite - ESRI
                var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 19
                });
                
                // Camada de mapa escuro - CartoDB
                var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                });
                
                // Camadas para armazenar pontos de temperatura
                var tempLayer = L.layerGroup();
                
                // Criar ícone personalizado para o marcador principal
                var weatherIconHtml = `<div style="width: 50px; height: 50px; background-image: url('https://openweathermap.org/img/wn/${icone}@2x.png'); 
                           background-size: contain; background-position: center; background-repeat: no-repeat;"></div>`;
                
                var weatherIcon = L.divIcon({
                    html: weatherIconHtml,
                    className: 'marker-icon',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });
                
                // Adicionar marcador principal
                var marker = L.marker([lat, lon], {icon: weatherIcon}).addTo(map);
                
                // Adicionar popup com informações
                var popupContent = `
                    <div class="weather-popup">
                        <h5>${cidade}</h5>
                        <img src="https://openweathermap.org/img/wn/${icone}@2x.png" alt="${descricao}">
                        <h4>${temperatura}°C</h4>
                        <p>${descricao}</p>
                    </div>
                `;
                
                marker.bindPopup(popupContent).openPopup();
                
                // Criar o círculo da área da cidade
                var raio = Math.max(500, Math.min(temperatura * 200, 2000));
                var circle = L.circle([lat, lon], {
                    color: getTemperatureColor(temperatura),
                    fillColor: getTemperatureColor(temperatura),
                    fillOpacity: 0.2,
                    radius: raio
                }).addTo(map);
                
                // Função para determinar a cor baseada na temperatura
                function getTemperatureColor(temp) {
                    if (temp <= 0) return '#9DC3E6';  // Muito frio (azul claro)
                    if (temp <= 10) return '#4472C4'; // Frio (azul)
                    if (temp <= 15) return '#70AD47'; // Fresco (verde)
                    if (temp <= 22) return '#FFC000'; // Moderado (amarelo)
                    if (temp <= 28) return '#ED7D31'; // Quente (laranja)
                    return '#FF0000';                 // Muito quente (vermelho)
                }
                
                // Função para obter descrição da temperatura
                function getTemperatureLabel(temp) {
                    if (temp <= 0) return 'Muito frio';
                    if (temp <= 10) return 'Frio';
                    if (temp <= 15) return 'Fresco';
                    if (temp <= 22) return 'Moderado';
                    if (temp <= 28) return 'Quente';
                    return 'Muito quente';
                }
                
                // Criar a legenda de temperatura
                function createTemperatureLegend() {
                    var legend = document.getElementById('temp-legend');
                    var legendContent = legend.querySelector('.legend-content');
                    legendContent.innerHTML = ''; // Limpar conteúdo existente
                    
                    var temps = [
                        {value: 0, label: 'Muito frio (≤ 0°C)'},
                        {value: 5, label: 'Frio (1-10°C)'},
                        {value: 12, label: 'Fresco (11-15°C)'},
                        {value: 18, label: 'Moderado (16-22°C)'},
                        {value: 25, label: 'Quente (23-28°C)'},
                        {value: 30, label: 'Muito quente (>28°C)'}
                    ];
                    
                    temps.forEach(function(temp) {
                        var item = document.createElement('div');
                        item.className = 'legend-item';
                        
                        var colorBox = document.createElement('div');
                        colorBox.className = 'legend-color';
                        colorBox.style.backgroundColor = getTemperatureColor(temp.value);
                        
                        var label = document.createElement('span');
                        label.textContent = temp.label;
                        
                        item.appendChild(colorBox);
                        item.appendChild(label);
                        legendContent.appendChild(item);
                    });
                    
                    // Mostrar a legenda
                    legend.style.display = 'block';
                }
                
                // Criar a legenda no início
                createTemperatureLegend();
                
                // Função para criar pontos de temperatura
                function createTemperaturePoints() {
                    // Limpar pontos existentes
                    tempLayer.clearLayers();
                    
                    // Criar pontos aleatórios ao redor
                    var numPoints = 12;
                    
                    for (var i = 0; i < numPoints; i++) {
                        var angle = (i / numPoints) * Math.PI * 2;
                        var distance = raio * 0.9;
                        
                        // Converter distância e ângulo para coordenadas
                        var offsetLat = (distance / 111320) * Math.cos(angle);
                        var offsetLon = (distance / (111320 * Math.cos(lat * Math.PI / 180))) * Math.sin(angle);
                        
                        var pointLat = lat + offsetLat;
                        var pointLon = lon + offsetLon;
                        
                        // Variação de temperatura
                        var tempVariation = (Math.random() - 0.5) * 3;
                        var pointTemp = Math.round((temperatura + tempVariation) * 10) / 10;
                        
                        // Cor baseada na temperatura
                        var tempColor = getTemperatureColor(pointTemp);
                        
                        // Criar ícone para o ponto de temperatura
                        var tempIconHtml = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; 
                            background-color: ${tempColor};">${pointTemp}</div>`;
                        
                        var tempIcon = L.divIcon({
                            html: tempIconHtml,
                            className: 'temp-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        // Adicionar marcador de temperatura
                        var tempMarker = L.marker([pointLat, pointLon], {icon: tempIcon})
                            .bindPopup(`<strong>${pointTemp}°C</strong><br>${getTemperatureLabel(pointTemp)}`);
                        
                        // Adicionar área de temperatura
                        var pointCircle = L.circle([pointLat, pointLon], {
                            color: tempColor,
                            fillColor: tempColor,
                            fillOpacity: 0.2,
                            radius: 400 + Math.random() * 300,
                            weight: 1
                        });
                        
                        // Adicionar à camada de temperatura
                        tempLayer.addLayer(pointCircle);
                        tempLayer.addLayer(tempMarker);
                    }
                }
                
                // Controles do mapa
                document.getElementById('btn-mapa-streets').addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.btn-group button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active a este botão
                    this.classList.add('active');
                    
                    // Mostrar camada de ruas
                    map.removeLayer(satelliteLayer);
                    map.removeLayer(darkLayer);
                    map.addLayer(osmLayer);
                    
                    // Remover pontos de temperatura
                    map.removeLayer(tempLayer);
                    
                    // Esconder a legenda
                    document.getElementById('temp-legend').style.display = 'none';
                });
                
                document.getElementById('btn-mapa-satellite').addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.btn-group button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active a este botão
                    this.classList.add('active');
                    
                    // Mostrar camada de satélite
                    map.removeLayer(osmLayer);
                    map.removeLayer(darkLayer);
                    map.addLayer(satelliteLayer);
                    
                    // Remover pontos de temperatura
                    map.removeLayer(tempLayer);
                    
                    // Esconder a legenda
                    document.getElementById('temp-legend').style.display = 'none';
                });
                
                document.getElementById('btn-mapa-dark').addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.btn-group button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active a este botão
                    this.classList.add('active');
                    
                    // Mostrar camada escura
                    map.removeLayer(osmLayer);
                    map.removeLayer(satelliteLayer);
                    map.addLayer(darkLayer);
                    
                    // Remover pontos de temperatura
                    map.removeLayer(tempLayer);
                    
                    // Esconder a legenda
                    document.getElementById('temp-legend').style.display = 'none';
                });
                
                document.getElementById('btn-mapa-temp').addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.btn-group button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active a este botão
                    this.classList.add('active');
                    
                    // Mostrar camada base
                    map.removeLayer(satelliteLayer);
                    map.removeLayer(darkLayer);
                    map.addLayer(osmLayer);
                    
                    // Criar e adicionar pontos de temperatura
                    createTemperaturePoints();
                    map.addLayer(tempLayer);
                    
                    // Mostrar a legenda
                    document.getElementById('temp-legend').style.display = 'block';
                });
                
                // Esconder mensagem de erro se o mapa carregou
                document.getElementById('error-message').style.display = 'none';
                
                // Recalcular tamanho do mapa quando for redimensionado
                window.addEventListener('resize', function() {
                    map.invalidateSize();
                });
                
            } catch (error) {
                console.error('Erro ao inicializar o mapa:', error);
                
                // Mostrar mensagem de erro
                document.getElementById('error-message').style.display = 'block';
                
                // Fornecer um mapa estático de fallback usando OpenStreetMap
                var mapContainer = document.getElementById('map');
                mapContainer.innerHTML = `
                    <div class="text-center p-4">
                        <h5>Mapa Estático</h5>
                        <div class="mt-3">
                            <img src="https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lon}&zoom=12&size=600x400&markers=${lat},${lon},red" 
                                alt="Mapa estático de ${cidade}" class="img-fluid rounded">
                        </div>
                        <p class="mt-2 small text-muted">Mapa estático fornecido por OpenStreetMap</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html> 